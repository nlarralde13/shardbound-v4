<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Shardbound · Play</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Play styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/play.css') }}">
</head>

<body>
  <!-- ======= TOP ACCOUNT BANNER ======= -->
  <header class="sb-navbar">
    <!-- Brand goes to login page for now; change to main.index if you prefer -->
    <a class="sb-logo sb-brand" href="{{ url_for('auth.login_page') }}" aria-label="Home">
      <span class="mark" aria-hidden="true"></span>
      <span>Shardbound</span>
    </a>

    <nav class="sb-nav" aria-label="Primary">
      <a href="{{ url_for('game.play') }}">Play</a>
      <a href="{{ url_for('main.index') }}#map">Map</a>
      <a href="{{ url_for('main.index') }}#inventory">Inventory</a>
      <a href="{{ url_for('main.index') }}#quests">Quests</a>
      <a href="{{ url_for('main.logs') }}">Logs</a>
    </nav>

    <div class="sb-spacer"></div>

    {% set _user = (current_user if (current_user is defined) else None) %}
    {% set _name = (_user.username if (_user and _user.is_authenticated) else (session.get('user', {}).get('username') if session is defined else None)) %}
    {% set username = _name or "Player" %}

    <div class="sb-userchip" id="userChip" aria-haspopup="menu" aria-expanded="false" title="Account">
      <div class="sb-avatar" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="8" r="4" stroke-width="1.6"/>
          <path d="M4 20c1-4 5-6 8-6s7 2 8 6" stroke-width="1.6" />
        </svg>
        <span class="sb-online"></span>
      </div>
      <span class="sb-username">{{ username }}</span>
      <svg class="sb-caret" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg>

      <div class="sb-menu" id="userMenu" role="menu" aria-label="User menu">
        <a class="sb-item" href="{{ url_for('main.index') }}#account">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="8" r="4"/><path d="M4 20c1-4 5-6 8-6s7 2 8 6"/></svg>
          <div>Account <div class="hint">Profile & security</div></div>
        </a>
        <a class="sb-item" href="{{ url_for('main.index') }}#settings">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06A2 2 0 1 1 4.27 19l.06-.06A1.65 1.65 0 0 0 4.66 17.1 1.65 1.65 0 0 0 3 15.5H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 7.04 4.27l.06.06c.48.48 1.17.63 1.82.33.66-.3 1.08-.94 1.08-1.65V3a2 2 0 1 1 4 0v.09c0 .71.42 1.35 1.08 1.65.65.3 1.34.15 1.82-.33l.06-.06A2 2 0 1 1 19.73 7l-.06.06c-.48.48-.63 1.17-.33 1.82.3.66.94 1.08 1.65 1.08H21a2 2 0 1 1 0 4h-.09c-.71 0-1.35.42-1.65 1.08Z"/></svg>
          <div>Settings <div class="hint">Audio, UI & gameplay</div></div>
        </a>
        <div class="sb-sep"></div>
        <a class="sb-item" href="https://discord.gg/your-server" target="_blank" rel="noopener">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 21c-3.5 1-7 1-10.5 0L8 19m8 0-1.5 2M7 9a4 4 0 1 0 0 8h10a4 4 0 0 0 0-8" /></svg>
          <div>Discord <div class="hint">Join the community</div></div>
          <span class="hint">↗</span>
        </a>
        <a class="sb-item" href="{{ url_for('main.docs') }}">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M6 4h7l5 5v11H6z"/><path d="M13 4v6h6"/></svg>
          <div>Help / Docs <div class="hint">Game guide & FAQ</div></div>
        </a>
        <a class="sb-item" href="{{ url_for('main.logs') }}">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 3h18v4H3zM3 11h18v10H3z"/><path d="M7 11v10M12 11v10M17 11v10"/></svg>
          <div>Session Logs <div class="hint">Debug & telemetry</div></div>
        </a>
        <div class="sb-sep"></div>
        <button class="sb-item sb-danger" type="button" id="logoutBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><path d="M16 17l5-5-5-5"/><path d="M21 12H9"/></svg>
          <div>Log out <div class="hint">Sign out of this session</div></div>
        </button>
      </div>
    </div>

    <!-- Hidden logout form (POST) -->
    <form id="logoutForm" action="{{ url_for('auth.logout') }}" method="post" style="display:none;">
      {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
    </form>
  </header>

  <!-- ======= MAIN CONTENT ======= -->
  <main id="app-root">
    <div class="play-layout" id="playLayout">
      <section class="panel panel-left" aria-labelledby="charPanelHeading">
        <header class="panel-header">
          <h2 id="charPanelHeading">Character</h2>
          <div id="onboardingStage" class="panel-subtitle">Adventure</div>
        </header>
        <div class="char-card">
          <div id="charPortrait" class="char-portrait" aria-hidden="true"></div>
          <div class="char-meta">
            <h3 id="charName">—</h3>
            <p id="charTitle" class="char-title">Create a character to begin</p>
            <dl class="char-stats">
              <div>
                <dt>Class</dt>
                <dd id="charClass">—</dd>
              </div>
              <div>
                <dt>XP</dt>
                <dd id="charXP">0</dd>
              </div>
              <div>
                <dt>Power</dt>
                <dd id="charPower">0</dd>
              </div>
            </dl>
          </div>
        </div>
        <div class="char-log" id="charLog" aria-live="polite"></div>
      </section>

      <section class="panel panel-center" aria-labelledby="battlePanelHeading">
        <header class="panel-header">
          <h2 id="battlePanelHeading">Battle Viewer</h2>
          <p class="panel-subtitle">Tutorial encounter</p>
        </header>
        <div id="battleviewer-root" class="battle-shell" role="application" aria-label="Battle Viewer"></div>
      </section>

      <section class="panel panel-right" aria-labelledby="encountersHeading">
        <header class="panel-header">
          <h2 id="encountersHeading">Encounters</h2>
          <p class="panel-subtitle">Nearby threats</p>
        </header>
        <div class="panel-section">
          <h3 class="panel-section-title">Hostiles</h3>
          <ul id="enemyList" class="list enemy-list" aria-live="polite"></ul>
        </div>
        <div class="panel-section">
          <h3 class="panel-section-title">Session Log</h3>
          <div id="sessionLog" class="log"></div>
        </div>
      </section>
    </div>

    <footer class="play-hud" role="status" aria-live="polite">
      <div class="hud-chip" id="hudNet">Network: —</div>
      <div class="hud-chip" id="hudUser">User: —</div>
      <div class="hud-chip" id="hudShard">Shard: —</div>
      <div class="hud-chip" id="hudCoords">Coords: —</div>
      <div class="hud-chip" id="hudBiome">Biome: —</div>
      <div class="hud-chip" id="hudFPS">FPS: —</div>
    </footer>

    <!-- Character Creation Modal (hidden by default) -->
    <div id="charCreateModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="ccTitle">
      <div class="modal-backdrop" data-close="cc"></div>
      <div class="modal-panel" role="document">
        <header class="modal-header">
          <h2 id="ccTitle">Create Your Character</h2>
          <button class="modal-close" id="ccCloseBtn" aria-label="Close">×</button>
        </header>

        <form id="charCreateForm" class="modal-body" autocomplete="off">
          <div class="form-row">
            <label for="ccName">Name</label>
            <input id="ccName" name="name" type="text" minlength="2" maxlength="24" required />
          </div>

          <div class="form-row">
            <label for="ccTitleInput">Title (optional)</label>
            <input id="ccTitleInput" name="title" type="text" maxlength="32" placeholder="e.g., ‘the Unbound’" />
          </div>

          <div class="form-row">
            <label for="ccClass">Class</label>
            <select id="ccClass" name="class" required>
              <option value="Warrior">Warrior</option>
              <option value="Mage">Mage</option>
              <option value="Cleric">Cleric</option>
              <option value="Ranger">Ranger</option>
              <option value="Rogue">Rogue</option>
              <option value="Monk">Monk</option>
            </select>
          </div>

          <!-- Portrait preview auto-updates based on class -->
          <div class="portrait-preview">
            <div id="ccPortrait" class="portrait-frame"></div>
          </div>

          <div id="ccError" class="form-error" role="alert" aria-live="assertive"></div>

          <footer class="modal-footer">
            <button type="submit" class="btn btn-primary" id="ccSubmit">Create Character</button>
            <button type="button" class="btn" id="ccCancel">Cancel</button>
          </footer>
        </form>
      </div>
    </div>
  </main>

  <script>
    window.__PLAY_APP__ = {
      battleRoot: document.getElementById('battleviewer-root'),
      log(message) {
        const logEl = document.getElementById('sessionLog');
        if (logEl) {
          const item = document.createElement('div');
          item.className = 'log-entry';
          item.textContent = message;
          logEl.prepend(item);
        }
        console.log('[play]', message);
      },
      setStatus(key, value) {
        const mapping = {
          shard: 'hudShard',
          coords: 'hudCoords',
          biome: 'hudBiome',
          fps: 'hudFPS',
          net: 'hudNet',
          user: 'hudUser'
        };
        const targetId = mapping[key] || null;
        if (targetId) {
          const el = document.getElementById(targetId);
          if (el) {
            el.textContent = value;
          }
        }
      }
    };
  </script>

  <!-- Page script -->
  <script type="module" src="{{ url_for('static', filename='js/play.js') }}"></script>
</body>
</html>
