<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Shardbound — Play</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/play.css') }}">



  <!-- Local overrides to force HUD 50% and make collapse bulletproof -->
  <style>
    /* Scale factor for HUD when visible */
    :root { --hud-scale: .5; --hud-height: 260px; }

    /* We render the battle scene into #viewerStage so we can transform/clip it safely */
    #battleviewer-root { position: relative; overflow: hidden; }
    #viewerStage { position: relative; width:100%; height:100%; }

    /* 50% HUD size: try common HUD containers; if none match, scale any bottom HUD-like blocks */
    #battleviewer-root.hud-compact .battle-hud,
    #battleviewer-root.hud-compact .hud,
    #battleviewer-root.hud-compact .combat-ui,
    #battleviewer-root.hud-compact .actor-panels,
    #battleviewer-root.hud-compact .actorPanel,
    #battleviewer-root.hud-compact .unit-panels,
    #battleviewer-root.hud-compact .unitPanel,
    #battleviewer-root.hud-compact .bottom-ui,
    #battleviewer-root.hud-compact .battle-footer,
    /* Heuristic: any element whose class name contains 'hud' */
    #battleviewer-root.hud-compact [class*="hud"] {
      transform: scale(var(--hud-scale));
      transform-origin: bottom left;
    }

    /* Prevent scaled HUD from overflowing horizontally; tuck it in */
    #battleviewer-root.hud-compact .battle-hud,
    #battleviewer-root.hud-compact .hud,
    #battleviewer-root.hud-compact .combat-ui,
    #battleviewer-root.hud-compact [class*="hud"] {
      margin-bottom: 0 !important;
      /* ensure it stays anchored at the bottom visually */
      position: relative;
      left: 0;
    }

    /* COLLAPSE: clip the bottom HUD area regardless of class names */
    #battleviewer-root.hud-hidden #viewerStage {
      clip-path: inset(0 0 var(--hud-height) 0);
      pointer-events: auto; /* scene remains interactive */
    }
    /* Backup: if your viewer uses fixed/absolute HUD, also hide common classes */
    body.hud-hidden .battle-hud,
    body.hud-hidden .hud,
    body.hud-hidden .combat-ui,
    body.hud-hidden .actor-panels,
    body.hud-hidden .actorPanel,
    body.hud-hidden .unit-panels,
    body.hud-hidden .unitPanel,
    body.hud-hidden .bottom-ui,
    body.hud-hidden .battle-footer,
    body.hud-hidden [class*="hud"] {
      display: none !important;
    }
  </style>
</head>
<body>

  <!-- ===== Top Banner ===================================================== -->
  <header class="topbar" role="banner">
    <div class="title">Shardbound: <span id="locationLabel">Onboarding</span></div>
    <div class="stage" id="onboardingStage">Intro • Step 0 of 4</div>
    <div class="actions">
      <button class="ghost" id="toggleLeft">Character</button>
      <button class="ghost" id="toggleHUD" aria-pressed="false">HUD</button>
      <button class="ghost" id="toggleRight">Actions</button>
    </div>
  </header>

  <!-- ===== Main 3-Column Layout ========================================== -->
  <main class="layout" role="main" aria-label="Game Layout">
    <!-- Left Sidebar: Character/Party -->
    <section id="leftSidebar" class="panel" aria-label="Character Sidebar">
      <div class="panel-header">
        <h3>Character</h3>
        <button class="ghost" data-collapse="left" aria-controls="leftSidebar" aria-expanded="true">Hide</button>
      </div>
      <div class="panel-body">
        <div class="card">
          <div class="char-head">
            <div class="char-portrait"></div>
            <div>
              <div id="charName" class="char-name">Unbound</div>
              <div id="charClass" class="char-class">—</div>
            </div>
          </div>
          <div class="stat-grid">
            <div class="stat"><span>HP</span><span id="statHP">—</span></div>
            <div class="stat"><span>MP</span><span id="statMP">—</span></div>
            <div class="stat"><span>ATK</span><span id="statATK">—</span></div>
            <div class="stat"><span>DEF</span><span id="statDEF">—</span></div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Inventory</div>
          <div id="invList" class="muted">(empty)</div>
        </div>
      </div>
    </section>

    <!-- Center Viewport: BattleViewer mount -->
    <section id="centerViewport" class="panel" aria-label="Viewport">
      <div class="panel-body panel-body--tight">
        <div id="battleviewer-root" class="hud-compact" aria-live="polite" aria-busy="true">
          <!-- We give your viewer a stable stage to mount into -->
          <div id="viewerStage">
            <div class="loading-skeleton">BattleViewer will load here…</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Right Sidebar: Actions / Job-board-style prompts + Log -->
    <aside id="rightSidebar" class="panel" aria-label="Actions Sidebar">
      <div class="panel-header">
        <h3>Actions</h3>
        <button class="ghost" data-collapse="right" aria-controls="rightSidebar" aria-expanded="true">Hide</button>
      </div>
      <div class="panel-body actions-body">
        <button class="btn" id="actionPrimary">Begin Tutorial</button>
        <button class="btn" id="actionSecondary">Explore Surroundings</button>
        <button class="btn" id="actionBoard">Visit Job Board</button>

        <div>
          <div class="card-title">Session Log</div>
          <div class="log" id="sessionLog" aria-live="polite">
            [system] Welcome to Shardbound. Creating your legend…
          </div>
        </div>
      </div>
    </aside>
  </main>

  <!-- ===== Bottom Console ================================================= -->
  <footer class="bottombar" role="contentinfo">
    <div class="row">
      <div class="tag" id="statusNet">Online</div>
      <div class="tag" id="statusUser">User: —</div>
      <div class="tag" id="statusShard">Shard: —</div>
      <div class="tag" id="statusFPS">FPS: —</div>
    </div>
  </footer>

  <!-- ===== Minimal bootstrap (non-blocking) =============================== -->
  <script type="module">
    const $ = sel => document.querySelector(sel);

    // Collapsers (left/right)
    const leftBtn = document.querySelector('[data-collapse="left"]');
    const rightBtn = document.querySelector('[data-collapse="right"]');
    const left = $('#leftSidebar');
    const right = $('#rightSidebar');

    function togglePanel(panel, btn){
      const isHidden = panel.classList.toggle('is-collapsed');
      btn.setAttribute('aria-expanded', String(!isHidden));
    }
    leftBtn?.addEventListener('click', ()=>togglePanel(left, leftBtn));
    rightBtn?.addEventListener('click', ()=>togglePanel(right, rightBtn));

    // Topbar quick toggles
    $('#toggleLeft')?.addEventListener('click', ()=>togglePanel(left, leftBtn));
    $('#toggleRight')?.addEventListener('click', ()=>togglePanel(right, rightBtn));

    // HUD toggle: press button or 'H'
    const hudBtn = $('#toggleHUD');
    const battleRoot = $('#battleviewer-root');

    function setHudHidden(hidden){
      // Clip the bottom HUD area and also hide common HUD classes
      battleRoot.classList.toggle('hud-hidden', hidden);
      document.body.classList.toggle('hud-hidden', hidden);
      // Keep the 50% size when visible
      battleRoot.classList.toggle('hud-compact', !hidden);
      hudBtn.setAttribute('aria-pressed', String(hidden));
    }
    function toggleHUD(){ setHudHidden(!battleRoot.classList.contains('hud-hidden')); }

    hudBtn?.addEventListener('click', toggleHUD);
    window.addEventListener('keydown', (e)=>{ if (e.key.toLowerCase() === 'h') toggleHUD(); });

    // Lightweight log until play.js takes over
    function log(msg){
      const el = $('#sessionLog');
      if(!el) return;
      const line = document.createElement('div');
      line.textContent = msg;
      el.appendChild(line);
      el.scrollTop = el.scrollHeight;
    }
    log('[ui] Play shell initialized.');

    // Expose the stage so your viewer mounts inside the clip/scale sandbox
    window.__PLAY_APP__ = {
      battleRoot: document.getElementById('viewerStage'),
      log,
      setStatus: (k,v)=>{ const map={
        net:'#statusNet', user:'#statusUser', shard:'#statusShard', fps:'#statusFPS'
      }; const el=$(map[k]); if(el) el.textContent=v; }
    };
  </script>

  <!-- Your real boot script -->
  <script type="module" src="{{ url_for('static', filename='js/play.js') }}"></script>
</body>
</html>
