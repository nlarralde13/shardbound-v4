<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Battle Box</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/static/css/battlebox.css">
</head>
<body>
  <div class="wrap">
    <!-- LEFT: class + basic controls -->
    <aside class="panel" id="leftPanel">
      <h2>Player Class</h2>
      <div class="list" id="classList"></div>

      <div class="controls">
        <label class="kv">
          <span>Level</span>
          <input type="number" id="levelInput" min="1" value="1">
        </label>
      </div>

      <div class="controls">
        <button id="fightBtn" class="btn primary">Fight â–¶</button>
      </div>

      <div class="footer">Uses class catalogs from <code>/static/catalog/classes</code>.</div>
    </aside>

    <!-- CENTER: viewer + background picker -->
    <main class="panel center" id="centerPanel">
      <h2>Battle Viewer</h2>

      <!-- Background picker -->
      <div class="controls row compact" id="bgControls">
        <label class="label">Background</label>
        <select id="bgSelect"></select>
        <input id="bgCustom" placeholder="filename.png or full URL" />
        <button id="bgApply" class="btn">Apply</button>
        <button id="bgClear" class="btn subtle">Clear</button>
      </div>

      <div id="sceneMount"></div>
      <!-- (no #sceneOverlay needed; HUD is an overlay child inside #sceneMount) -->
    </main>

    <!-- RIGHT: enemy picker + tuning -->
    <aside class="panel" id="rightPanel">
      <h2>Enemy</h2>

      <div class="controls row compact">
        <input id="enemyFilter" placeholder="Filterâ€¦ (e.g., goblin)" />
        <button id="enemyRandom" class="btn">ðŸŽ² Random</button>
      </div>

      <div class="list" id="enemyList"></div>
      <div class="footer">Loads from <code>/static/catalog/enemies.json</code>.</div>

      <h2 class="section">Tuning</h2>
      <div class="controls column">
        <label class="slider">
          <span>Viewer Height</span>
          <input type="range" id="viewerHeight" min="40" max="95" value="80">
          <output id="vhVal">80vh</output>
        </label>

        <label class="slider">
          <span>HUD Opacity</span>
          <input type="range" id="hudOpacity" min="20" max="95" value="72">
          <output id="hoVal">0.72</output>
        </label>

        <label class="slider">
          <span>HUD Blur</span>
          <input type="range" id="hudBlur" min="0" max="16" value="6">
          <output id="hbVal">6px</output>
        </label>

        <label class="slider">
          <span>Left Pane Width</span>
          <input type="range" id="leftWidth" min="200" max="360" value="240">
          <output id="lwVal">240px</output>
        </label>

        <label class="slider">
          <span>Right Pane Width</span>
          <input type="range" id="rightWidth" min="200" max="360" value="240">
          <output id="rwVal">240px</output>
        </label>

        <label class="slider">
          <span>Grid Gap</span>
          <input type="range" id="gridGap" min="4" max="28" value="12">
          <output id="ggVal">12px</output>
        </label>

        <div class="controls row compact">
          <button id="resetLayout" class="btn subtle">Reset Layout</button>
        </div>
      </div>
    </aside>
  </div>

  <!-- Your existing sandbox bootstrap -->
  <script type="module" src="/static/js/sandbox/battleSandbox.js"></script>

  <!-- Background manifest-driven picker -->
  <script type="module">
    const MANIFEST_URL = '/static/assets/art/backgrounds/manifest.json';
    const selectEl = document.getElementById('bgSelect');
    const customEl = document.getElementById('bgCustom');
    const applyBtn = document.getElementById('bgApply');
    const clearBtn = document.getElementById('bgClear');
    const mount    = document.getElementById('sceneMount');

    function applyBackground(url) {
      mount.style.backgroundImage    = url ? `url(${url})` : 'none';
      mount.style.backgroundSize     = 'cover';
      mount.style.backgroundPosition = 'center';
      mount.style.backgroundRepeat   = 'no-repeat';
      if (url) mount.style.backgroundColor = '#0b111b';
      localStorage.setItem('battle_bg', url || '');
    }

    function option(label, value, id='') {
      const o = document.createElement('option');
      o.value = value; o.textContent = label; if (id) o.dataset.id = id;
      return o;
    }

    async function loadManifest() {
      try {
        const res = await fetch(MANIFEST_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch (e) {
        console.warn('[bg] manifest load failed, using fallback:', e);
        return {
          basePath: '/static/assets/art/backgrounds/',
          backgrounds: [
            { id: 'none',        label: 'â€” None â€”',   file: '' },
            { id: 'goblin_camp', label: 'Goblin Camp',file: 'goblin_camp.png' },
            { id: 'sewers',      label: 'Sewers',     file: 'sewers.png' },
            { id: 'shard_peak',  label: 'Shard Peak', file: 'shard_peak.png' }
          ]
        };
      }
    }

    function buildSelect(manifest) {
      const base = manifest.basePath || '';
      const list = manifest.backgrounds || [];
      selectEl.innerHTML = '';

      const none = list.find(b => !b.file) || { id: 'none', label: 'â€” None â€”', file: '' };
      selectEl.appendChild(option(none.label || 'â€” None â€”', '', none.id || 'none'));

      for (const b of list) {
        if (!b.file) continue;
        selectEl.appendChild(option(b.label || b.file, base + b.file, b.id || ''));
      }
    }

    function restore(manifest) {
      const saved = localStorage.getItem('battle_bg') || '';
      if (saved) {
        applyBackground(saved);
        const match = [...selectEl.options].find(o => o.value === saved);
        if (match) selectEl.value = saved;
        else customEl.value = saved.startsWith(manifest.basePath) ? saved.slice(manifest.basePath.length) : saved;
      } else {
        selectEl.value = '';
      }
    }

    selectEl.addEventListener('change', () => {
      customEl.value = '';
      applyBackground(selectEl.value || '');
    });

    applyBtn.addEventListener('click', () => {
      const v = (customEl.value || '').trim();
      if (!v) { selectEl.value = ''; applyBackground(''); return; }
      const base = v.startsWith('http') ? '' : (JSON.parse(sessionStorage.getItem('bg_manifest') || '{}').basePath || '/static/assets/art/backgrounds/');
      applyBackground(base + v);
      selectEl.value = ''; // custom overrides select
    });

    clearBtn.addEventListener('click', () => {
      selectEl.value = ''; customEl.value = ''; applyBackground('');
    });

    (async () => {
      const manifest = await loadManifest();
      sessionStorage.setItem('bg_manifest', JSON.stringify(manifest));
      buildSelect(manifest);
      restore(manifest);
    })();
  </script>

  <!-- Enemy filter + tuners (pure front-end) -->
  <script type="module">
    const $ = (id) => document.getElementById(id);

    // --- enemy filter / random ---
    const enemyFilter = $('enemyFilter');
    const enemyRandom = $('enemyRandom');
    const enemyListEl = $('enemyList');

    function filterEnemies() {
      const q = (enemyFilter.value || '').toLowerCase().trim();
      [...enemyListEl.querySelectorAll('button')].forEach(b => {
        b.style.display = b.textContent.toLowerCase().includes(q) ? '' : 'none';
      });
    }
    enemyFilter.addEventListener('input', filterEnemies);

    enemyRandom.addEventListener('click', () => {
      const visible = [...enemyListEl.querySelectorAll('button')].filter(b => b.style.display !== 'none');
      if (!visible.length) return;
      const pick = visible[Math.floor(Math.random() * visible.length)];
      pick.click(); // leverage existing onclick in battleSandbox.js
      // quick visual flash
      pick.classList.add('pulse'); setTimeout(()=>pick.classList.remove('pulse'), 350);
    });

    // --- layout tuners (CSS variables) ---
    const root = document.documentElement.style;

    const viewerHeight = $('viewerHeight');
    const hudOpacity   = $('hudOpacity');
    const hudBlur      = $('hudBlur');
    const leftWidth    = $('leftWidth');
    const rightWidth   = $('rightWidth');
    const gridGap      = $('gridGap');

    const vhVal = $('vhVal'), hoVal = $('hoVal'), hbVal = $('hbVal');
    const lwVal = $('lwVal'), rwVal = $('rwVal'), ggVal = $('ggVal');

    function setVar(name, val){ root.setProperty(name, val); }

    function initFromInputs() {
      setVar('--viewer-height', viewerHeight.value + 'vh');
      setVar('--hud-opacity', (Number(hudOpacity.value) / 100).toString());
      setVar('--hud-blur', hudBlur.value + 'px');
      setVar('--left-width', leftWidth.value + 'px');
      setVar('--right-width', rightWidth.value + 'px');
      setVar('--grid-gap', gridGap.value + 'px');

      vhVal.textContent = viewerHeight.value + 'vh';
      hoVal.textContent = (Number(hudOpacity.value)/100).toFixed(2);
      hbVal.textContent = hudBlur.value + 'px';
      lwVal.textContent = leftWidth.value + 'px';
      rwVal.textContent = rightWidth.value + 'px';
      ggVal.textContent = gridGap.value + 'px';
    }

    [viewerHeight,hudOpacity,hudBlur,leftWidth,rightWidth,gridGap].forEach(inp=>{
      inp.addEventListener('input', initFromInputs);
    });

    $('resetLayout').addEventListener('click', () => {
      viewerHeight.value = 80;
      hudOpacity.value   = 72;
      hudBlur.value      = 6;
      leftWidth.value    = 240;
      rightWidth.value   = 240;
      gridGap.value      = 12;
      initFromInputs();
      localStorage.removeItem('battle_bg');
    });

    // first run
    initFromInputs();
  </script>
</body>
</html>
